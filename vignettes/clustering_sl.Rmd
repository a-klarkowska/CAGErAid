---
title: "Clustering (SL)"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Clustering (SL)}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---




```r
library(CAGErAid) |> suppressPackageStartupMessages()
library('CAGEr') |> suppressPackageStartupMessages()
library('ggplot2'); theme_set(theme_bw())
```

Let's load in the polished data from [the previous vignette](vignettes/loading_polishing.Rmd):


```r
ce_path <- system.file("extdata/example_CAGEexp", package="CAGErAid") |>
  list.files(pattern = '*toOSA_polished*', full.names = TRUE)

ce <- SimpleList()
ce$OKItoOSA <- readRDS(ce_path[1])
#> Error in gzfile(file, "rb"): invalid 'description' argument
ce$OSAtoOSA <- readRDS(ce_path[2])
#> Error in gzfile(file, "rb"): invalid 'description' argument
```

Let's also load in the GFF file for annotating clusters:


```r
gff <- system.file("extdata", "Osaka.gtf", package="CAGErAid") |> 
  quickGFF()
#> Error in h(simpleError(msg, call)): error in evaluating the argument 'con' in selecting a method for function 'import': Cannot detect format (no extension found in file name)
```

We separate SL containing samples and check for power law distribution.


```r

for (i in names(ce)) {
  ce[[i]] <- ce[[i]][, ce[[i]]$SLfound]
}

sapply(ce, \(x) plot(plotReverseCumulatives(x, fitInRange = NULL, values = 'raw')))
#> list()
```

As seen in the reverse cumulative plot, samples with SL do not follow a power law distribution. In this case we use simple TPM normalization.


```r

ce <- sapply(ce, \(x) normalizeTagCount(x, method = 'simpleTpm')) |>
  suppressWarnings()
sapply(ce, \(x) plot(plotReverseCumulatives(x, fitInRange = NULL, values = 'normalized')))
#> list()
```

After normalization, we can cluster the CTSSs. First, let's annotate the data.


```r
ce <- sapply(ce, \(x) annotateCTSS(x, gff)) |> suppressWarnings()
```

Now we can find consensus clusters with the use of `quickCC()`. For SL-containing samples, the function uses the paraclu algorithm.


```r
ce <- sapply(ce, \(x) quickCC(x, sl_found = TRUE, gff = gff, nr_samples = 1)) |> 
  suppressWarnings()
```

Finally, we can save the CAGEexp objects and export the data to the bed format for visualisation.


