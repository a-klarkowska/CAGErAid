---
title: "Clustering SL data - BAR to BAR"
author: "Anna Klarkowska"
date: "2023-10-18"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r libraries}

library('CAGEr')
library('ggplot2'); theme_set(theme_minimal())
library('pheatmap')
library('BSgenome')
library('patchwork')
library('devtools')
library('CAGErAid')

```

# Load in data from the [polishing](./vignettes/polishing.Rmd) file

```{r load in data}

ce <- readRDS('./data/BARtoBAR.rds')

```

```{r}

# load GFF files
gff <- quickGFF('/bucket/LuscombeU/live/CharlesPlessy/CAGE/2022-11-09_Barcelona_Oik/AlignWithRNAseqPipelinePE_BAR/Bar2_p4.gm.gtf')

```

# Clustering

Separate SL containing samples

```{r}

ce_sl <- ce[, ce$SLfound] |>
  normalizeTagCount(method = "simpleTpm") |>
  annotateCTSS(gff)

```

```{r plot reverse cumulatives}

plotReverseCumulatives(ce_sl,
                       fitInRange = NULL,
                       values = "raw",
                       onePlot = TRUE)

plotReverseCumulatives(ce_sl,
                       fitInRange = NULL,
                       values = "normalized",
                       onePlot = TRUE)

```

```{r simple clustering and aggregating}

ce_sl <- quickClustersSL(ce_sl, aggregate = T, gff)

```

```{r export to bed - maybe}

cctrack_sl <- exportToTrack(ce_sl, "consensusClusters")#, qLow = 0.1, qUp = 0.9)
# Error in h(simpleError(msg, call)) : 
# error in evaluating the argument 'x' in selecting a method for function 'decode': subscript contains invalid names

cctrack_sl@trackLine@description <- "CAGE Consensus Clusters for trans splicing sites"
cctrack_sl@trackLine@name <- "sl"
# Flat AG
cctrack_sl$itemRgb <- ifelse(flagByUpstreamSequences(rowRanges(consensusClustersSE(ce_sl))$dominant_ctss, "AG"), "black", "grey")

cctrack_sl[cctrack_sl$itemRgb == "black"] |> score() |> decode() |> log10() |> hist(br=100)
cctrack_sl[cctrack_sl$itemRgb == "grey"]  |> score() |> decode() |> log10() |> hist(br=100)

# cctrack_sl <- makeBed(ce_sl, TRUE)
rtracklayer::export.bed(cctrack_sl, "clusters_sl_bartobar.bed")
```
Note: it would appear that all tracks that get exported have a score of 0 uniformly, becuase if qLow and qUp are set to NULL, exportToTrack() works, but the subsequent score() calls don't.

#' @rdname exportToTrack

setMethod( "exportToTrack", "ConsensusClusters"
           , function( object, what, qLow, qUp
                       , colorByExpressionProfile, oneTrack) {
  score(object) <- 0L
  exportToTrack( GRanges(object), qLow = qLow, qUp = qUp
                 , colorByExpressionProfile = colorByExpressionProfile
                 , oneTrack = oneTrack)
})

I think this chunk in CAGEr's ExportMethods.R might be at fault



