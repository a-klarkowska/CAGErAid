---
title: "polishing"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{polishing}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r libraries}
library('CAGEr')
library('ggplot2'); theme_set(theme_minimal())
library('pheatmap')
library('devtools')
library('CAGErAid')
```

# Load in data from the [loading](./vignettes/loading.Rmd) file

```{r load in data}

ce <- SimpleList()
ce$BARtoBAR <- readRDS('./data/BARtoBAR.rds')
ce$BARtoOKI <- readRDS('./data/BARtoOKI.rds')
ce$BARtoOSA <- readRDS('./data/BARtoOSA.rds')

ce$OKItoBAR <- readRDS('./data/OKItoBAR.rds')
ce$OKItoOKI <- readRDS('./data/OKItoOKI.rds')
ce$OKItoOSA <- readRDS('./data/OKItoOSA.rds')

ce$OSAtoBAR <- readRDS('./data/OSAtoBAR.rds')
ce$OSAtoOKI <- readRDS('./data/OSAtoOKI.rds')
ce$OSAtoOSA <- readRDS('./data/OSAtoOSA.rds')

```


# Adding Hisat2 and general QC stats to metadata

```{r hisat2 and general stats QC}

for (i in names(ce)) ce[[i]] <- quickMQC(ce[[i]])

```

```{r ploting mapping stats}

plotAnnot_ <- function(name)
  plotAnnot(ce[[name]], msScope_nfcore_rnaseq, group = 'RNA', facet = 'SLfactor', norm = FALSE) +
      ylab('Number of tags processed') +
      xlab('Sample name') +
      scale_y_continuous(guide = guide_axis(angle = 45)) +
      theme(plot.subtitle=element_text(size=8, face="italic")) +
      ggtitle(paste0(name, ': QC report of CAGE library alignment'),
              sub = 'The splice leader sequence was detected and removed before alignment')

for (name in names(ce)) plot(plotAnnot_(name))

```

```{r annotating the CTSSs}

# load GFF files
gff_bar <- quickGFF('/bucket/LuscombeU/live/CharlesPlessy/CAGE/2022-11-09_Barcelona_Oik/AlignWithRNAseqPipelinePE_BAR/Bar2_p4.gm.gtf')
gff_oki <- quickGFF('/bucket/LuscombeU/live/CharlesPlessy/CAGE/2021-12-17_Okinawa_Oik/AlignWithRNAseqPipelinePE_OKI/Okinawa.genes.gtf')
gff_osa <- quickGFF('/bucket/LuscombeU/live/CharlesPlessy/CAGE/2022-02-09_Osaka_Oik/AlignWithRNAseqPipelinePE_OSA/OSKA2016v1.9.gm.gtf')


for (i in grep('toBAR', names(ce))) suppressWarnings(annotateCTSS(ce[[i]], gff_bar))
for (i in grep('toOKI', names(ce))) suppressWarnings(annotateCTSS(ce[[i]], gff_oki))
for (i in grep('toOSA', names(ce))) suppressWarnings(annotateCTSS(ce[[i]], gff_osa))


# annotated results
for (i in names(ce)) {
  print(names(ce[i]))
  print(colData(ce[[i]])[, c('librarySizes', 'promoter', 'exon', 'intron', 'unknown')])}

# proportions
for (i in names(ce)) {
  print(names(ce[i]))
  print(colData(ce[[i]])[,c('promoter', 'exon', 'intron', 'unknown')] |> as.matrix() |> prop.table(1)  |> round(2))
        }

```

```{r plot annotated results - normalized counts}

plotAnnot_ <- function(name)
  plotAnnot(ce[[name]], 'counts', group = 'RNA', facet = 'SLfactor', normalise = TRUE) +
      ylab('Fraction of tags aligned') +
      xlab('Sample name') +
      scale_y_continuous(guide = guide_axis(angle = 45)) +
      theme(plot.subtitle=element_text(size=8, face="italic")) +
      ggtitle(paste0(name, ': Annotation of the aligned tags'),
              sub = 'The promoters are defined as the 1-kb window centered on the transcript start site.')

for (name in names(ce)) plot(plotAnnot_(name))

```

```{r correlate expression per chromosome}

roughClusters <- function(name) {
  seqNameTotalsSE(ce[[name]]) |> assay() |> cor(meth='spe') |> pheatmap::pheatmap(main = name)
}

# seqNameTotalsSE(ce_OSAtoOSA) |> assay()

for (name in names(ce)) roughClusters(name)

```

```{r reverse cumulative distribution of the CTSSes}

colors_bar <- c("red", "red", "red",  "red", "blue",  "blue" ,"pink", "pink"  ,"pink","pink",  "green", "green",   "green", "green",  "green",  "green",  "green" ,  "green" )
colors_oki <- c("red", "red", "pink", "pink", "blue", "blue", "lightblue", "lightblue","green", "green")
colors_osa <- c("purple", "purple", "red", "red", "pink", "pink", "blue", "blue", "lightblue", "lightblue", "green", "green")

# NOT CHECKED
for (i in grep('BARto', names(ce))) ce[[i]] <- setColors(ce[[i]], colors_bar)
for (i in grep('OKIto', names(ce))) ce[[i]] <- setColors(ce[[i]], colors_oki)
for (i in grep('OSAto', names(ce))) ce[[i]] <- setColors(ce[[i]], colors_osa)


# commented out plots that don't work
# TBD
plotReverseCumulatives(ce$BARtoBAR, fitInRange = c(1e3, 1e5), values = "raw", onePlot = T) 
# plotReverseCumulatives(ce$BARtoOKI, fitInRange = c(1e3, 1e5), values = "raw", onePlot = T) 
# plotReverseCumulatives(ce$BARtoOSA, fitInRange = c(1e3, 1e5), values = "raw", onePlot = T) 

plotReverseCumulatives(ce$OKItoBAR, fitInRange = c(1e3, 1e5), values = "raw", onePlot = T) 
plotReverseCumulatives(ce$OKItoOKI, fitInRange = c(1e3, 1e5), values = "raw", onePlot = T) 
# plotReverseCumulatives(ce$OKItoOSA, fitInRange = c(1e3, 1e5), values = "raw", onePlot = T) 

plotReverseCumulatives(ce$OSAtoBAR, fitInRange = c(1e3, 1e5), values = "raw", onePlot = T) 
# plotReverseCumulatives(ce$OSAtoOKI, fitInRange = c(1e3, 1e5), values = "raw", onePlot = T) 
plotReverseCumulatives(ce$OSAtoOSA, fitInRange = c(1e3, 1e5), values = "raw", onePlot = T) 

```

```{r exporting unclustered data to bed or bw - maybe, eval=FALSE, include=FALSE}

# bed
for (i in names(ce)) {
  ce[[i]] <- normalizeTagCount(ce[[i]])
  trks <- exportToTrack(ce[[i]], oneTrack = FALSE)
  for (n in seq_along(trks)) {
    name <- sampleLabels(ce[[i]])[n]
    rtracklayer::export.bed(trks[n], paste0("./data/bed/", name, ".ctss.bed.gz"))
  }

# bigWig
  for (n in seq_along(trks)) {
    name <- sampleLabels(ce[[i]])[n]
    trkL <- split(trks[[n]], strand(trks[[n]]), drop = TRUE)
    trkL[['+']]@trackLine@description <- paste(name, " plus")
    trkL[['-']]@trackLine@description <- paste(name, " plus")
    rtracklayer::export.bw(trkL[['+']], paste0("./data/bw/", name, ".plus.bw"))
    rtracklayer::export.bw(trkL[['-']], paste0("./data/bw/", name, ".minus.bw"))
  }
}

```

```{r saving modified CAGEexp objects}

saveRDS(ce$BARtoBAR, file = './data/polished/BARtoBAR.rds')
saveRDS(ce$BARtoOKI, file = './data/polished/BARtoOKI.rds')
saveRDS(ce$BARtoOSA, file = './data/polished/BARtoOSA.rds')

saveRDS(ce$OKItoBAR, file = './data/polished/OKItoBAR.rds')
saveRDS(ce$OKItoOKI, file = './data/polished/OKItoOKI.rds')
saveRDS(ce$OKItoOSA, file = './data/polished/OKItoOSA.rds')

saveRDS(ce$OSAtoBAR, file = './data/polished/OSAtoBAR.rds')
saveRDS(ce$OSAtoOKI, file = './data/polished/OSAtoOKI.rds')
saveRDS(ce$OSAtoOSA, file = './data/polished/OSAtoOSA.rds')

```
